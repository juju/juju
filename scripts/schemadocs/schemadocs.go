// Copyright 2019 Canonical Ltd.
// Licensed under the AGPLv3, see LICENCE file for details.
package main

import (
	"encoding/json"
	"fmt"
	"html/template"
	"io/ioutil"
	"log"
	"os"
	"sort"
	"strings"
)

func main() {
	// the first argument here will be the name of the binary, so we ignore
	// argument 0 when looking for the filepath.
	if len(os.Args) != 2 {
		fmt.Fprintln(os.Stderr, "Expected one argument: filepath of json schema to read.")
		os.Exit(1)
	}

	data, err := ioutil.ReadFile(os.Args[1])
	if err != nil {
		log.Fatal(err)
	}

	var input []JSONFacade
	if err := json.Unmarshal(data, &input); err != nil {
		log.Fatal(err)
	}

	sort.Slice(input, func(i, j int) bool {
		f1, f2 := input[i], input[j]
		if f1.Name != f2.Name {
			return f1.Name < f2.Name
		}
		return f1.Version > f2.Version
	})

	output := make([]TemplateFacade, len(input))
	for k, facade := range input {
		methods := make([]TemplateMethod, 0, len(facade.Schema.Properties))
		for k, prop := range facade.Schema.Properties {
			methods = append(methods, TemplateMethod{
				Name:        k,
				Description: prop.Description,
				Param:       prop.Properties.Params.Ref,
				Result:      prop.Properties.Result.Ref,
			})
		}
		sort.Slice(methods, func(i, j int) bool {
			return methods[i].Name < methods[j].Name
		})

		definitions := make([]TemplateDefinition, 0, len(facade.Schema.Definitions))
		for k, prop := range facade.Schema.Definitions {
			properties := make([]TemplateProperty, 0, len(prop.Properties))
			for k, v := range prop.Properties {
				ref := v.Ref.Ref
				if v.Type == "array" {
					if v.Items.Type != "" {
						ref = v.Items.Type
					} else {
						ref = v.Items.Ref
					}
				}
				properties = append(properties, TemplateProperty{
					Name:   k,
					Type:   v.Type,
					Format: v.Format,
					Ref:    ref,
				})
			}
			sort.Slice(properties, func(i, j int) bool {
				return properties[i].Name < properties[j].Name
			})

			definitions = append(definitions, TemplateDefinition{
				Name:       k,
				Type:       prop.Type,
				Properties: properties,
			})
		}
		sort.Slice(definitions, func(i, j int) bool {
			return definitions[i].Name < definitions[j].Name
		})

		output[k] = TemplateFacade{
			Name:        facade.Name,
			AvailableTo: facade.AvailableTo,
			Description: facade.Description,
			Version:     facade.Version,
			Methods:     methods,
			Definitions: definitions,
		}
	}

	t, err := template.New("").Funcs(tmplFuncs).Parse(htmlTmpl)
	if err != nil {
		log.Fatal(err)
	}
	if err := t.Execute(os.Stdout, output); err != nil {
		log.Fatal(err)
	}
}

// JSONFacade represents the facade in json schema form
type JSONFacade struct {
	Name        string
	Description string
	Version     int
	AvailableTo []string
	Schema      JSONFacadeSchema
}

// JSONFacadeSchema represents the facade schema object in json schema form
type JSONFacadeSchema struct {
	Type        string                      `json:"type"`
	Description string                      `json:"description"`
	Properties  map[string]PropertySchema   `json:"properties"`
	Definitions map[string]DefinitionSchema `json:"definitions"`
}

// PropertySchema represents the property schema object in json schema form
type PropertySchema struct {
	Description string   `json:"description"`
	Type        string   `json:"type"`
	Properties  Property `json:"properties"`
}

// Property represents the property object in json schema form
type Property struct {
	Description string
	Params      Ref
	Result      Ref
}

// Ref represents a reference to another object
type Ref struct {
	Ref         string `json:"$ref"`
	Type        string `json:"type"`
	Description string `json:"description"`
}

// DefinitionSchema represents a definition in json schema form
type DefinitionSchema struct {
	Ref
	Format               string                      `json:"format"`
	Properties           map[string]DefinitionSchema `json:"properties"`
	AdditionalProperties bool                        `json:"additionalProperties"`
	Required             []string                    `json:"required"`
	Items                Ref                         `json:"items"`
}

// TemplateFacade represents a facade for templating usage
type TemplateFacade struct {
	Name        string
	Description string
	Version     int
	AvailableTo []string
	Methods     []TemplateMethod
	Definitions []TemplateDefinition
}

// TemplateMethod represents a facade method for templating usage
type TemplateMethod struct {
	Name        string
	Description string
	Param       string
	Result      string
}

// TemplateDefinition represents a facade definition for templating usage
type TemplateDefinition struct {
	Name       string
	Type       string
	Properties []TemplateProperty
}

type TemplateProperty struct {
	Name   string
	Type   string
	Format string
	Ref    string
}

var htmlTmpl = `
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Juju API docs (autogenerated)</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<style>
nav, main, footer {
	padding-left: 350px;
}
.sidenav .user-view {
	height: 180px;
	width: 100%;
}
.sidenav img {
	margin: -20px 0 0 20px;
	height: 160px;
}
</style>
</head>
<body>
<header>
	<ul class="sidenav sidenav-fixed" style="transform: translateX(0px);">
		<li>
			<div class="user-view">
				<img class="center-align" src="data:image/png;base64,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" />
			</div>
		</li>
		<li><div class="divider"></div></li>
	{{range .}}
		<li><a href="#{{.Name}}">{{.Name}} v{{.Version}}</a></li>
	{{end}}
		<li><div class="divider"></div></li>
	</ul>
</header>
<nav>
	<div class="nav-wrapper">
		<a id="top" href="#top" class="brand-logo">Juju API facades</a>
	</div>
</nav>
<main>
	<blockquote>
	The following are API facades for the Juju API. Each facade is versioned to
	ensure that backwards and forwards compatibility is achievable when using
	various versions of CLI and controllers.
	</blockquote>
	<blockquote>
	Although each facade in the API is versioned, the parameters are not, so
	it's worth noting that definitions could potentially break if removal or
	modifying a definition occurs between versions of Facades.
	</blockquote>
	<hr />
	{{range .}}
	{{$facade_name:=.Name}}
		<h2 id="{{.Name}}"><a href="#{{.Name}}">{{.Name}}</a> v{{.Version}}</h2>
		<blockquote>{{.Description}}</blockquote>
		<h5>Facade Type</h5>
		<ol>
			{{range .AvailableTo}}
				<li>{{.}}</li>
			{{end}}
		</ol>
		<div style="float:right">
			<ul>
				<li>Jump to <a href="#{{.Name}}_definitions">Definitions</a></li>
				<li>Jump to <a href="#top">Top</a></li>
			</ul>
		</div>
		<div style="clear:both"></div>
		<table class="highlight">
			<tr>
				<th>Name</th>
				<th>Params</th>
				<th>Results</th>
				<th>Description</th>
			</tr>
			{{range .Methods}}
			<tr>
				<td>{{.Name}}</td>
				<td><a href="#{{$facade_name}}_{{.Param | defLink}}">{{.Param | defName}}</a></td>
				<td><a href="#{{$facade_name}}_{{.Result | defLink}}">{{.Result | defName}}</a></td>
				<td>{{.Description}}</td>
			</tr>
			{{end}}
		</table>
		<h3 id="{{.Name}}_definitions"><a href="#{{.Name}}_definitions">{{.Name}} Definitions</a></h3>
		<div style="float:right">
			<ul>
				<li>Jump to <a href="#{{.Name}}">Methods</a></li>
				<li>Jump to <a href="#top">Top</a></li>
			</ul>
		</div>
		<div style="clear:both"></div>
		{{range .Definitions}}
		<h4 id="{{$facade_name}}_definitions_{{.Name}}"><a href="#{{$facade_name}}_definitions_{{.Name}}">{{.Name}}</a></h4>
		<table class="highlight">
			<tr>
				<th>Name</th>
				<th>Type</th>
				<th>Format</th>
				<th>Reference</th>
			</tr>
			{{range .Properties}}
			<tr>
				<td>{{.Name}}</td>
				<td>{{.Type | typeRef .Ref}}</td>
				<td>{{.Format}}</td>
				<td><a href="#{{$facade_name}}_{{.Ref | defLink}}">{{.Ref | defName}}</a></td>
			</tr>
			{{end}}
		</table>
		{{end}}
		<hr />
	{{end}}
</main>
<footer class="page-footer docs-footer">
© 2019 Canonical Ltd
</footer>
</body>
</html>
`

var tmplFuncs = template.FuncMap{
	"join": func(sep string, ss []string) string {
		return strings.Join(ss, sep)
	},
	"defLink": func(name string) string {
		if strings.HasPrefix(name, "#/") {
			name = name[2:]
		}
		return strings.Replace(name, "/", "_", -1)
	},
	"defName": func(name string) string {
		return strings.TrimPrefix(name, "#/definitions/")
	},
	"typeRef": func(ref, typ string) string {
		if typ != "array" && strings.HasPrefix(ref, "#/") {
			return "Ref"
		}
		return typ
	},
}
