#!/bin/bash
set -x

export PATH=$PWD/plugin:$PATH
ACTIVE_FILE=$PWD/.active

if [ -e $ACTIVE_FILE ]; then
    status-set maintenance "reading active file ($ACTIVE_FILE)"
    name=$(cat $ACTIVE_FILE)

    status-set maintenance "launching ${name}..."
    output=$(process-launch "$name" 2>&1)
    rc=$?
    if [ -z "$output" ]; then
        output='<no output>'
    fi
    if [ "$rc" = "0" ]; then
        status-set active "workload process ${name} launched ($output)"
    else
        status-set waiting "workload process ${name} failed to launch ($rc - $output)"
        rm $ACTIVE_FILE
        exit $rc
    fi
else
    status-set blocked 'not active; skipping...'
fi
exit 0
